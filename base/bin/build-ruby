#!/bin/bash
set -euo pipefail

export PREFIX=/usr/local

# Install ruby-build
git clone --branch "v${DEVON_REX_RUBY_BUILD_VERSION}" --single-branch \
    https://github.com/rbenv/ruby-build.git \
    /tmp/ruby-build
/tmp/ruby-build/install.sh
cd ~
rm -rf /tmp/ruby-build
[[ $(ruby-build --version) = "ruby-build ${DEVON_REX_RUBY_BUILD_VERSION}" ]] || (echo 'Unexpected ruby-build version!' ; exit 1)
ruby-build --version

# Install Ruby
ruby-build "$GLOBAL_RUBY_VERSION" "$PREFIX"
[[ $(ruby -e 'puts RUBY_VERSION') = "$GLOBAL_RUBY_VERSION" ]] || (echo 'Unexpected Ruby version!' ; exit 1)
ruby -v

# Configure `gem` command
cat<<'EOF' >> "${PREFIX}/etc/gemrc"
install: --no-document
update: --no-document
EOF

# See https://stackoverflow.com/a/4774063
SCRIPT_PATH="$( cd "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )"
"${SCRIPT_PATH}/install-bundler"
